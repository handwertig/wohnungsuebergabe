<!DOCTYPE html>
<html>
<head>
    <title>Request Flow Debugging</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f8f9fa; }
        .container { max-width: 1000px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin: 20px 0; }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; color: white; }
        .btn-primary { background: #007bff; }
        .btn-success { background: #28a745; }
        .btn-danger { background: #dc3545; }
        .alert { padding: 15px; margin: 10px 0; border-radius: 5px; }
        .alert-info { background: #d1ecf1; color: #0c5460; }
        .alert-success { background: #d4edda; color: #155724; }
        .alert-danger { background: #f8d7da; color: #721c24; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        input, select { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 Request Flow Debugging</h1>
        
        <div class="alert alert-info">
            <strong>Ziel:</strong> Verfolge jeden Schritt des Save-Requests um das exakte Problem zu identifizieren.
        </div>
        
        <div class="grid">
            <div class="card">
                <h3>🧪 Direkter Save-Test</h3>
                <p>Testet den Save-Prozess direkt mit vollständigem Tracing.</p>
                
                <form id="traceForm">
                    <label>Neuer Mieter Name:</label>
                    <input type="text" id="traceTenantName" placeholder="Test Name eingeben...">
                    
                    <label>Typ:</label>
                    <select id="traceType">
                        <option value="auszug">Auszug</option>
                        <option value="einzug">Einzug</option>
                    </select>
                    
                    <button type="button" class="btn btn-primary" onclick="runDirectTrace()">🔬 Trace Save Process</button>
                </form>
            </div>
            
            <div class="card">
                <h3>📋 Normal Edit Form Test</h3>
                <p>Testet das normale Edit-Formular.</p>
                
                <button class="btn btn-success" onclick="testNormalEditForm()">📝 Test Normal Form</button>
                <button class="btn btn-danger" onclick="interceptFormSubmit()">🔍 Intercept Form Submit</button>
                
                <div id="formStatus"></div>
            </div>
        </div>
        
        <div class="card">
            <h3>📊 Request Routing Test</h3>
            <button class="btn btn-primary" onclick="testRouting()">🔄 Test /protocols/save Routing</button>
            <button class="btn btn-success" onclick="testEmergencyHandler()">🚨 Test Emergency Handler</button>
            <button class="btn btn-danger" onclick="compareResponses()">⚖️ Compare Response Paths</button>
        </div>
        
        <div id="results"></div>
    </div>

    <script>
        async function runDirectTrace() {
            const tenantName = document.getElementById('traceTenantName').value || 'TRACE TEST ' + new Date().toLocaleTimeString();
            const type = document.getElementById('traceType').value;
            
            showResult('🔬 Starte direkten Trace...', 'info');
            
            try {
                const formData = new FormData();
                formData.append('id', '82cc7de7-7d1e-11f0-89a6-822b82242c5d');
                formData.append('tenant_name', tenantName);
                formData.append('type', type);
                
                showResult('📤 Sende Request an /trace_save.php...', 'info');
                
                const response = await fetch('/trace_save.php', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showResult('✅ TRACE ERFOLGREICH!', 'success');
                    showResult('🎯 Neue Daten: ' + result.new_tenant_name, 'success');
                    showResult('🕐 Update Zeit: ' + result.update_time, 'info');
                    
                    if (result.verification) {
                        showResult('✅ Verifikation erfolgreich: ' + result.verification.tenant_name, 'success');
                    }
                } else {
                    showResult('❌ TRACE FEHLGESCHLAGEN: ' + result.error, 'danger');
                }
                
                showResult('📋 Vollständige Antwort:', 'info');
                showResult(JSON.stringify(result, null, 2), 'info');
                
                // Jetzt prüfen ob das normale System die Änderung sieht
                setTimeout(checkCurrentStatus, 1000);
                
            } catch (error) {
                showResult('❌ Trace Request fehlgeschlagen: ' + error.message, 'danger');
            }
        }

        async function testNormalEditForm() {
            showResult('📝 Teste normales Edit-Formular...', 'info');
            
            try {
                // Lade das normale Edit-Formular
                const response = await fetch('/protocols/edit?id=82cc7de7-7d1e-11f0-89a6-822b82242c5d');
                const html = await response.text();
                
                // Prüfe ob Formular korrekt geladen wurde
                if (html.includes('protocol-edit-form')) {
                    showResult('✅ Edit-Formular gefunden', 'success');
                    
                    // Extrahiere aktuellen Mieter Namen
                    const tenantMatch = html.match(/name="tenant_name"[^>]*value="([^"]*)"/);
                    if (tenantMatch) {
                        const currentTenant = tenantMatch[1];
                        showResult('📋 Aktueller Mieter: ' + currentTenant, 'info');
                        
                        // Prüfe Form Action
                        const actionMatch = html.match(/action="([^"]*)"[^>]*id="protocol-edit-form"/);
                        if (actionMatch) {
                            showResult('🎯 Form Action: ' + actionMatch[1], 'info');
                        }
                        
                        // Prüfe CSRF Token
                        if (html.includes('_csrf_token')) {
                            showResult('🔐 CSRF Token gefunden (PROBLEM!)', 'danger');
                        } else {
                            showResult('✅ Kein CSRF Token (OK)', 'success');
                        }
                        
                    } else {
                        showResult('❌ Mieter Name Feld nicht gefunden', 'danger');
                    }
                } else {
                    showResult('❌ Edit-Formular nicht gefunden', 'danger');
                }
                
            } catch (error) {
                showResult('❌ Edit-Formular Test fehlgeschlagen: ' + error.message, 'danger');
            }
        }

        async function testRouting() {
            showResult('🔄 Teste Routing zu /protocols/save...', 'info');
            
            try {
                // Test verschiedene Request-Methoden
                const tests = [
                    { method: 'GET', expected: 'Should redirect or error' },
                    { method: 'POST', data: { test: 'routing' }, expected: 'Should reach emergency handler' }
                ];
                
                for (const test of tests) {
                    showResult(`🧪 Test ${test.method} zu /protocols/save...`, 'info');
                    
                    const options = {
                        method: test.method
                    };
                    
                    if (test.data) {
                        const formData = new FormData();
                        Object.keys(test.data).forEach(key => {
                            formData.append(key, test.data[key]);
                        });
                        options.body = formData;
                    }
                    
                    try {
                        const response = await fetch('/protocols/save', options);
                        showResult(`📊 ${test.method} Response: ${response.status} ${response.statusText}`, 
                                 response.ok ? 'success' : 'danger');
                        
                        const contentType = response.headers.get('Content-Type');
                        showResult(`📄 Content-Type: ${contentType}`, 'info');
                        
                    } catch (fetchError) {
                        showResult(`❌ ${test.method} Request failed: ${fetchError.message}`, 'danger');
                    }
                }
                
            } catch (error) {
                showResult('❌ Routing Test fehlgeschlagen: ' + error.message, 'danger');
            }
        }

        async function testEmergencyHandler() {
            showResult('🚨 Teste Emergency Handler direkt...', 'info');
            
            try {
                const formData = new FormData();
                formData.append('id', '82cc7de7-7d1e-11f0-89a6-822b82242c5d');
                formData.append('tenant_name', 'EMERGENCY DIRECT TEST ' + new Date().toLocaleTimeString());
                formData.append('type', 'auszug');
                
                const response = await fetch('/emergency_save.php', {
                    method: 'POST',
                    body: formData
                });
                
                showResult('📊 Emergency Response Status: ' + response.status, response.ok ? 'success' : 'danger');
                
                const contentType = response.headers.get('Content-Type');
                showResult('📄 Content-Type: ' + contentType, 'info');
                
                if (response.redirected) {
                    showResult('🔄 Redirect zu: ' + response.url, 'success');
                } else {
                    const text = await response.text();
                    showResult('📝 Response Body (first 200 chars): ' + text.substring(0, 200), 'info');
                }
                
            } catch (error) {
                showResult('❌ Emergency Handler Test fehlgeschlagen: ' + error.message, 'danger');
            }
        }

        async function interceptFormSubmit() {
            showResult('🔍 Öffne Edit-Formular in neuem Tab für Intercept...', 'info');
            
            // Öffne Edit-Formular in neuem Tab
            const editWindow = window.open('/protocols/edit?id=82cc7de7-7d1e-11f0-89a6-822b82242c5d', '_blank');
            
            showResult('📝 Edit-Formular geöffnet. Füge Intercept-Code hinzu...', 'info');
            
            // Warte kurz und füge dann Intercept-Code hinzu
            setTimeout(() => {
                try {
                    const interceptScript = `
                        // Form Submit Interceptor
                        const form = document.getElementById('protocol-edit-form');
                        if (form) {
                            form.addEventListener('submit', function(e) {
                                e.preventDefault();
                                console.log('FORM SUBMIT INTERCEPTED!');
                                console.log('Action:', form.action);
                                console.log('Method:', form.method);
                                
                                const formData = new FormData(form);
                                const data = {};
                                for (let [key, value] of formData.entries()) {
                                    data[key] = value;
                                }
                                console.log('Form Data:', data);
                                
                                // Zeige Daten in Alert
                                alert('INTERCEPTED FORM SUBMIT:\\n' + 
                                      'Action: ' + form.action + '\\n' +
                                      'Tenant Name: ' + (data.tenant_name || 'not set') + '\\n' +
                                      'Protocol ID: ' + (data.id || 'not set'));
                                
                                return false;
                            });
                            console.log('Form intercept installed successfully');
                        } else {
                            console.error('Form not found for intercept');
                        }
                    `;
                    
                    editWindow.eval(interceptScript);
                    showResult('✅ Intercept-Code installiert. Teste jetzt das Speichern im anderen Tab!', 'success');
                    
                } catch (error) {
                    showResult('❌ Intercept installation fehlgeschlagen: ' + error.message, 'danger');
                }
            }, 2000);
        }

        async function compareResponses() {
            showResult('⚖️ Vergleiche Response Paths...', 'info');
            
            const testData = {
                id: '82cc7de7-7d1e-11f0-89a6-822b82242c5d',
                tenant_name: 'COMPARE TEST ' + new Date().toLocaleTimeString(),
                type: 'auszug'
            };
            
            const formData = new FormData();
            Object.keys(testData).forEach(key => {
                formData.append(key, testData[key]);
            });
            
            try {
                // Test 1: Normal routing via /protocols/save
                showResult('🧪 Test 1: Normal routing (/protocols/save)...', 'info');
                const response1 = await fetch('/protocols/save', {
                    method: 'POST',
                    body: formData
                });
                
                showResult(`📊 Normal Route: ${response1.status} ${response1.statusText}`, 
                         response1.ok ? 'success' : 'danger');
                showResult(`🔄 Redirected: ${response1.redirected}`, 'info');
                if (response1.redirected) {
                    showResult(`🎯 Redirect URL: ${response1.url}`, 'info');
                }
                
                // Test 2: Direct emergency handler
                showResult('🧪 Test 2: Direct emergency (/emergency_save.php)...', 'info');
                const formData2 = new FormData();
                Object.keys(testData).forEach(key => {
                    formData2.append(key, testData[key] + '_DIRECT');
                });
                
                const response2 = await fetch('/emergency_save.php', {
                    method: 'POST',
                    body: formData2
                });
                
                showResult(`📊 Emergency Route: ${response2.status} ${response2.statusText}`, 
                         response2.ok ? 'success' : 'danger');
                showResult(`🔄 Redirected: ${response2.redirected}`, 'info');
                
                // Vergleiche Resultate
                showResult('📊 Vergleich abgeschlossen. Prüfe jetzt die aktuellen Daten...', 'info');
                setTimeout(checkCurrentStatus, 1000);
                
            } catch (error) {
                showResult('❌ Response Vergleich fehlgeschlagen: ' + error.message, 'danger');
            }
        }

        async function checkCurrentStatus() {
            showResult('📊 Prüfe aktuellen Status in der Database...', 'info');
            
            try {
                const response = await fetch('/check_silent_test.php');
                const result = await response.json();
                
                if (result.success !== undefined) {
                    showResult('📋 Aktuelle Database-Daten:', 'success');
                    showResult(`📝 Mieter: ${result.current_tenant}`, 'info');
                    showResult(`📅 Updated: ${result.last_updated}`, 'info');
                    showResult(`⏰ Recently updated: ${result.recently_updated}`, 'info');
                } else {
                    showResult('❌ Status Check fehlgeschlagen', 'danger');
                    showResult(JSON.stringify(result, null, 2), 'danger');
                }
                
            } catch (error) {
                showResult('❌ Status Check Error: ' + error.message, 'danger');
            }
        }

        function showResult(message, type) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = 'alert alert-' + type;
            
            if (typeof message === 'object') {
                div.innerHTML = '<pre>' + JSON.stringify(message, null, 2) + '</pre>';
            } else if (message.includes('\n') && message.length > 100) {
                div.innerHTML = '<pre>' + message + '</pre>';
            } else {
                div.textContent = new Date().toLocaleTimeString() + ' - ' + message;
            }
            
            results.appendChild(div);
            
            // Auto-scroll
            div.scrollIntoView({ behavior: 'smooth' });
        }

        // Auto-start basic tests
        window.addEventListener('load', function() {
            setTimeout(testNormalEditForm, 500);
        });
    </script>
</body>
</html>