<!DOCTYPE html>
<html>
<head>
    <title>CACHE BUSTING & FINAL FIX</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f8f9fa; }
        .container { max-width: 800px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin: 20px 0; }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; color: white; text-decoration: none; display: inline-block; }
        .btn-danger { background: #dc3545; }
        .btn-success { background: #28a745; }
        .btn-primary { background: #007bff; }
        .alert { padding: 15px; margin: 10px 0; border-radius: 5px; }
        .alert-warning { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔥 CACHE BUSTING & FINAL FIX</h1>
        
        <div class="alert alert-warning">
            <strong>PROBLEM IDENTIFIZIERT:</strong> Das normale Edit-Formular hat noch CSRF Token im Browser-Cache, obwohl wir es aus dem Controller entfernt haben!
        </div>
        
        <div class="card">
            <h3>🎯 SOFORTIGE LÖSUNGEN:</h3>
            
            <h4>1. Cache-Busting (EMPFOHLEN)</h4>
            <button class="btn btn-danger" onclick="clearAllCaches()">🗑️ ALLE CACHES LEEREN</button>
            <button class="btn btn-primary" onclick="forceReload()">🔄 FORCE RELOAD</button>
            
            <h4>2. Direkter Fix-Test</h4>
            <a href="/protocols/edit?id=82cc7de7-7d1e-11f0-89a6-822b82242c5d&bust=<?= time() ?>" class="btn btn-success" target="_blank">🚀 Edit-Formular (Cache-Busted)</a>
            
            <h4>3. Immediate Fix für Edit-Formular</h4>
            <button class="btn btn-primary" onclick="injectNoCSRFScript()">⚡ CSRF-KILL Script injizieren</button>
            
        </div>
        
        <div class="card">
            <h3>📝 Test nach Cache-Clear:</h3>
            <ol>
                <li>Klicke "🗑️ ALLE CACHES LEEREN"</li>
                <li>Warte 3 Sekunden</li>
                <li>Klicke "🚀 Edit-Formular (Cache-Busted)"</li>
                <li>Prüfe im neuen Tab ob CSRF Token weg ist (F12 → Elements suchen nach "_csrf_token")</li>
                <li>Teste das Speichern mit neuem Namen</li>
            </ol>
        </div>
        
        <div id="results"></div>
    </div>

    <script>
        async function clearAllCaches() {
            showResult('🗑️ Leere alle Browser-Caches...', 'warning');
            
            try {
                // 1. Service Worker Caches
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    showResult('📁 Gefundene Caches: ' + cacheNames.length, 'info');
                    
                    for (const cacheName of cacheNames) {
                        await caches.delete(cacheName);
                        showResult('🗑️ Cache gelöscht: ' + cacheName, 'success');
                    }
                }
                
                // 2. Local Storage
                if (typeof(Storage) !== "undefined") {
                    localStorage.clear();
                    sessionStorage.clear();
                    showResult('🗑️ Local/Session Storage geleert', 'success');
                }
                
                // 3. IndexedDB (falls vorhanden)
                if ('indexedDB' in window) {
                    try {
                        const databases = await indexedDB.databases();
                        for (const db of databases) {
                            if (db.name) {
                                indexedDB.deleteDatabase(db.name);
                                showResult('🗑️ IndexedDB gelöscht: ' + db.name, 'success');
                            }
                        }
                    } catch (e) {
                        // IndexedDB.databases() nicht unterstützt
                    }
                }
                
                showResult('✅ ALLE CACHES GELEERT!', 'success');
                showResult('⏳ Warte 3 Sekunden vor Reload...', 'warning');
                
                setTimeout(() => {
                    showResult('🔄 Erzwinge vollständigen Browser-Reload...', 'warning');
                    window.location.reload(true);
                }, 3000);
                
            } catch (error) {
                showResult('❌ Cache-Clearing Error: ' + error.message, 'error');
            }
        }

        function forceReload() {
            showResult('🔄 Force Reload wird durchgeführt...', 'warning');
            
            // Mehrere Reload-Strategien
            if (window.location.reload) {
                window.location.reload(true); // Force reload with cache bypass
            } else {
                window.location.href = window.location.href + '?bust=' + Date.now();
            }
        }

        function injectNoCSRFScript() {
            showResult('⚡ CSRF-Kill Script wird vorbereitet...', 'warning');
            
            const script = `
// CSRF TOKEN KILLER SCRIPT
(function() {
    console.log('🔥 CSRF KILLER ACTIVATED');
    
    // Entferne alle existierenden CSRF Token
    const csrfInputs = document.querySelectorAll('input[name="_csrf_token"]');
    csrfInputs.forEach(input => {
        console.log('🗑️ Removing CSRF token:', input);
        input.remove();
    });
    
    // Überwache Form-Submits und entferne CSRF Token dynamisch
    document.addEventListener('submit', function(e) {
        const form = e.target;
        const csrfInput = form.querySelector('input[name="_csrf_token"]');
        if (csrfInput) {
            console.log('🚫 BLOCKING CSRF token on submit');
            csrfInput.remove();
        }
    });
    
    // MutationObserver für dynamisch hinzugefügte CSRF Token
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            mutation.addedNodes.forEach(function(node) {
                if (node.nodeType === 1) { // Element node
                    const csrfInputs = node.querySelectorAll ? node.querySelectorAll('input[name="_csrf_token"]') : [];
                    csrfInputs.forEach(input => {
                        console.log('🚫 Auto-removing dynamically added CSRF token');
                        input.remove();
                    });
                }
            });
        });
    });
    
    observer.observe(document.body, { childList: true, subtree: true });
    
    console.log('✅ CSRF KILLER INSTALLED');
    alert('⚡ CSRF-Kill Script aktiviert! Öffne jetzt das Edit-Formular.');
})();
`;
            
            // Kopiere Script in Zwischenablage
            navigator.clipboard.writeText(script).then(() => {
                showResult('📋 CSRF-Kill Script in Zwischenablage kopiert!', 'success');
                showResult('📝 ANWEISUNGEN:', 'warning');
                showResult('1. Öffne das Edit-Formular in neuem Tab', 'info');
                showResult('2. Drücke F12 für Dev Tools', 'info');
                showResult('3. Gehe zu Console Tab', 'info');
                showResult('4. Füge das Script ein (Ctrl+V) und drücke Enter', 'info');
                showResult('5. Das Script entfernt automatisch alle CSRF Token!', 'info');
                
                // Zusätzlich: Versuche das Script direkt zu injizieren wenn möglich
                try {
                    eval(script);
                    showResult('⚡ Script auch lokal ausgeführt!', 'success');
                } catch (e) {
                    showResult('ℹ️ Script nur in Zwischenablage - manuell einfügen', 'info');
                }
            }).catch(() => {
                showResult('📝 Bitte kopiere das folgende Script manuell:', 'warning');
                showResult(script, 'info');
            });
        }

        function showResult(message, type) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = 'alert alert-' + (type === 'error' ? 'danger' : type === 'info' ? 'primary' : type);
            
            if (message.includes('\n') && message.length > 100) {
                div.innerHTML = '<pre>' + message + '</pre>';
            } else {
                div.textContent = new Date().toLocaleTimeString() + ' - ' + message;
            }
            
            results.appendChild(div);
            
            // Auto-scroll
            div.scrollIntoView({ behavior: 'smooth' });
        }

        // Auto-Info beim Laden
        window.addEventListener('load', function() {
            showResult('🎯 CACHE-BUSTING SUITE GELADEN', 'success');
            showResult('💡 Das Problem: Browser cached das alte Edit-Formular mit CSRF Token', 'warning');
            showResult('🔧 Lösung: Cache leeren → Formular neu laden → Testen', 'info');
        });
    </script>
</body>
</html>