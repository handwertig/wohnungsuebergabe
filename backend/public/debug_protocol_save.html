<!DOCTYPE html>
<html>
<head>
    <title>Protocol Save Debug Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .error { background: #f8d7da; color: #721c24; padding: 10px; margin: 10px 0; border-radius: 5px; }
        input, textarea, select { margin: 5px 0; padding: 5px; width: 300px; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>Protocol Save Debug Test</h1>
    
    <div class="debug">
        <h3>Debug Information</h3>
        <p><strong>Protocol ID:</strong> 82cc7de7-7d1e-11f0-89a6-822b82242c5d</p>
        <p><strong>Current Time:</strong> <span id="currentTime"></span></p>
        <p><strong>Form Action:</strong> /protocols/save</p>
    </div>

    <form id="protocolForm" method="POST" action="/protocols/save">
        <h3>CSRF Token</h3>
        <input type="text" name="_csrf_token" placeholder="CSRF Token wird automatisch geladen..." readonly>
        
        <h3>Basic Data</h3>
        <input type="hidden" name="id" value="82cc7de7-7d1e-11f0-89a6-822b82242c5d">
        
        <label>Type:</label><br>
        <select name="type">
            <option value="einzug">Einzug</option>
            <option value="auszug" selected>Auszug</option>
            <option value="zwischenprotokoll">Zwischenprotokoll</option>
        </select><br>
        
        <label>Tenant Name:</label><br>
        <input type="text" name="tenant_name" value="" placeholder="Wird automatisch geladen..."><br>
        
        <label>Owner ID:</label><br>
        <input type="text" name="owner_id" value=""><br>
        
        <label>Manager ID:</label><br>
        <input type="text" name="manager_id" value=""><br>

        <h3>Address</h3>
        <label>City:</label><br>
        <input type="text" name="address[city]" value="Test Stadt Debug"><br>
        
        <label>Street:</label><br>
        <input type="text" name="address[street]" value="Test Stra√üe Debug"><br>
        
        <label>House Number:</label><br>
        <input type="text" name="address[house_no]" value="123"><br>
        
        <label>Unit Label:</label><br>
        <input type="text" name="address[unit_label]" value="Debug Einheit"><br>

        <h3>Meta</h3>
        <label>Notes:</label><br>
        <textarea name="meta[notes]" rows="3" placeholder="Debug Test Notizen..."></textarea><br>

        <div class="debug">
            <button type="button" onclick="loadProtocolData()">1. Load Current Protocol Data</button>
            <button type="button" onclick="generateCSRF()">2. Generate CSRF Token</button>
            <button type="button" onclick="updateTenantName()">3. Update Tenant Name</button>
            <button type="submit">4. Submit Form</button>
        </div>
        
        <div id="responseArea"></div>
    </form>

    <script>
        // Set current time
        document.getElementById('currentTime').textContent = new Date().toLocaleString();

        // Function to load current protocol data
        async function loadProtocolData() {
            try {
                const response = await fetch('/protocols/edit?id=82cc7de7-7d1e-11f0-89a6-822b82242c5d');
                const html = await response.text();
                
                // Extract tenant name from the response (basic parsing)
                const tenantMatch = html.match(/name="tenant_name"[^>]*value="([^"]*)"/)
                if (tenantMatch) {
                    document.querySelector('input[name="tenant_name"]').value = tenantMatch[1];
                    showMessage('‚úÖ Protocol data loaded: ' + tenantMatch[1], 'success');
                } else {
                    showMessage('‚ö† Could not extract tenant name from edit page', 'error');
                }
            } catch (error) {
                showMessage('‚ùå Error loading protocol data: ' + error.message, 'error');
            }
        }

        // Function to generate CSRF token (simplified)
        async function generateCSRF() {
            try {
                // Try to extract CSRF token from edit page
                const response = await fetch('/protocols/edit?id=82cc7de7-7d1e-11f0-89a6-822b82242c5d');
                const html = await response.text();
                
                const csrfMatch = html.match(/name="_csrf_token"[^>]*value="([^"]*)"/)
                if (csrfMatch) {
                    document.querySelector('input[name="_csrf_token"]').value = csrfMatch[1];
                    showMessage('‚úÖ CSRF token loaded: ' + csrfMatch[1].substring(0, 10) + '...', 'success');
                } else {
                    showMessage('‚ùå Could not extract CSRF token', 'error');
                }
            } catch (error) {
                showMessage('‚ùå Error generating CSRF token: ' + error.message, 'error');
            }
        }

        // Function to update tenant name with timestamp
        function updateTenantName() {
            const currentName = document.querySelector('input[name="tenant_name"]').value;
            const baseName = currentName.replace(/ \[DEBUG .*?\]$/, ''); // Remove previous debug suffix
            const newName = baseName + ' [DEBUG ' + new Date().toLocaleTimeString() + ']';
            document.querySelector('input[name="tenant_name"]').value = newName;
            document.querySelector('textarea[name="meta[notes]"]').value = 'Debug Test durchgef√ºhrt am: ' + new Date().toLocaleString();
            showMessage('‚úÖ Tenant name updated: ' + newName, 'success');
        }

        // Function to show messages
        function showMessage(message, type) {
            const responseArea = document.getElementById('responseArea');
            const div = document.createElement('div');
            div.className = type;
            div.textContent = message;
            responseArea.appendChild(div);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (div.parentNode) {
                    div.parentNode.removeChild(div);
                }
            }, 5000);
        }

        // Form submit handler
        document.getElementById('protocolForm').addEventListener('submit', function(e) {
            const csrfToken = document.querySelector('input[name="_csrf_token"]').value;
            const tenantName = document.querySelector('input[name="tenant_name"]').value;
            
            if (!csrfToken) {
                e.preventDefault();
                showMessage('‚ùå CSRF token is missing. Please generate it first.', 'error');
                return;
            }
            
            if (!tenantName) {
                e.preventDefault();
                showMessage('‚ùå Tenant name is missing. Please load protocol data first.', 'error');
                return;
            }
            
            showMessage('üöÄ Submitting form with CSRF: ' + csrfToken.substring(0, 10) + '... and tenant: ' + tenantName, 'success');
        });

        // Auto-load on page ready
        window.addEventListener('load', function() {
            setTimeout(loadProtocolData, 500);
            setTimeout(generateCSRF, 1000);
        });
    </script>
</body>
</html>